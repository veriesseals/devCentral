{% extends "base.html" %}
{% load static %}

{# LEFT RAIL: members list #}
{% block left_rail %}
<section class="card">
  <h3>Members</h3>
  <ul class="members-list">
    {% for m in all_users %}
      {% if m.username %}
        <li class="member-row">
          <a class="member-link" href="{% url 'social:profile' m.username %}">
            <span class="member-avatar">
              {% if m.profile.avatar %}
                <img src="{{ m.profile.avatar.url }}" alt="{{ m.username }}" loading="lazy">
              {% else %}
                <img src="{% static 'img/avatar-default.png' %}" alt="avatar" loading="lazy">
              {% endif %}
            </span>
            <span class="member-name">@{{ m.username }}</span>
          </a>
          {% if user != m %}
            <div class="member-actions">
              {% if user in m.profile.followers.all %}
                <form action="{% url 'social:unfollow' m.username %}" method="post" class="inline-form">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button type="submit" class="btn btn-small">Unfollow</button>
                </form>
              {% else %}
                <form action="{% url 'social:follow' m.username %}" method="post" class="inline-form">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button type="submit" class="btn btn-small">Follow</button>
                </form>
              {% endif %}
            </div>
          {% endif %}
        </li>
      {% endif %}
    {% empty %}
      <li class="muted">No members yet.</li>
    {% endfor %}
  </ul>
</section>
{% endblock %}

{# CENTER: composer + posts (no extra asides/columns here) #}
{% block content %}

<section class="card compose-card">
  <form action="{% url 'social:post-create' %}" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ post_form.body }}
    <div class="row">
      {{ post_form.image }}
      <button type="submit" class="btn">Post</button>
    </div>
  </form>
</section>

{% if posts %}
  {% for post in posts %}
  <article id="post-{{ post.id }}" class="card post-card">
    <div class="avatar">
      {% if post.author.profile.avatar %}
        <img src="{{ post.author.profile.avatar.url }}" alt="{{ post.author.username }}" loading="lazy">
      {% else %}
        <img src="{% static 'img/avatar-default.png' %}" alt="avatar" loading="lazy">
      {% endif %}
    </div>

    <div class="content">
      <div class="meta">
        <a class="username" href="{% url 'social:profile' post.author.username %}">@{{ post.author.username }}</a>
        <span class="time">{{ post.created_at|date:"M d, Y H:i" }}</span>

        {% if user != post.author %}
          {% if user in post.author.profile.followers.all %}
            <form action="{% url 'social:unfollow' post.author.username %}" method="post" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="btn-unfollow">Unfollow</button>
            </form>
          {% else %}
            <form action="{% url 'social:follow' post.author.username %}" method="post" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <button type="submit" class="btn-follow">Follow</button>
            </form>
          {% endif %}
        {% endif %}
      </div>

      <div class="post-body markdown-output">
        {% if post.rendered_html %}
          {{ post.rendered_html|safe }}
        {% else %}
          <div data-post-body>{{ post.body }}</div>
        {% endif %}
      </div>

      {% if post.image %}
        <img class="post-image" src="{{ post.image.url }}" alt="post image" loading="lazy">
      {% endif %}

      <div class="actions">
        <form action="{% url 'social:post-react' post.id 'like' %}" method="post" class="inline-form">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="submit" class="btn-like">üëç {{ post.likes_count }}</button>
        </form>
        <form action="{% url 'social:post-react' post.id 'dislike' %}" method="post" class="inline-form">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="submit" class="btn-dislike">üëé {{ post.dislikes_count }}</button>
        </form>
        <form action="{% url 'social:post-share' post.id %}" method="post" class="inline-form">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="submit" class="btn-share">üîÅ {{ post.shares_count }}</button>
        </form>

        {% if user == post.author %}
          <a class="btn btn-small btn-ghost" href="{% url 'social:post-edit' post.id %}">Edit</a>
          <form action="{% url 'social:post-delete' post.id %}" method="post" class="inline-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger btn-small" onclick="return confirm('Delete this post?');">Delete</button>
          </form>
        {% endif %}
      </div>

      <details class="replies">
        <summary>Replies ({{ post.reply_count|default:post.replies.count }})</summary>
        <ul>
          {% for r in post.reply_list|default:post.replies.all %}
            <li>
              <strong>@{{ r.author.username }}</strong>
              {{ r.body }}
              <em>{{ r.created_at|date:"M d H:i" }}</em>
            </li>
          {% empty %}
            <li>No replies yet.</li>
          {% endfor %}
        </ul>

        <form action="{% url 'social:post-reply' post.id %}" method="post">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.path }}#post-{{ post.id }}">
          <textarea name="body" rows="3" placeholder="Write a reply‚Ä¶" required></textarea>
          <div style="margin-top:8px;">
            <button class="btn" type="submit">Reply</button>
          </div>
        </form>
      </details>
    </div>
  </article>
  {% endfor %}
{% else %}
  <p>No posts yet. Say hi! üëã</p>
{% endif %}

{% endblock %}
