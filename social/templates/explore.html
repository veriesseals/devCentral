
{% extends 'base.html' %}
{% load static %}

{# ============ LEFT RAIL ============ #}
{% block left_rail %}
  <div class="card">
    <nav class="menu">
      <a class="menu-link" href="{% url 'social:feed' %}">Feed</a>
      <a class="menu-link active" href="{% url 'social:explore' %}">Explore</a>
      <a class="menu-link" href="{% url 'social:users' %}">Users</a>
      <a class="menu-link" href="{% url 'social:profile' user.username %}">My Profile</a>
    </nav>
  </div>
{% endblock %}

{# ============ CENTER COLUMN (EXPLORE) ============ #}
{% block content %}
  <h2 class="page-title">Explore ‚Äî All posts</h2>

  {% if posts %}
    {% for post in posts %}
      <article id="post-{{ post.id }}" class="card post-card">
        <div class="post-head">
          <div class="avatar">
            {% if post.author.profile.avatar %}
              <img src="{{ post.author.profile.avatar.url }}" alt="{{ post.author.username }}" loading="lazy">
            {% else %}
              <img src="{% static 'img/avatar-default.png' %}" alt="avatar" loading="lazy">
            {% endif %}
          </div>

          <div class="meta">
            <a class="username" href="{% url 'social:profile' post.author.username %}">@{{ post.author.username }}</a>
            <span class="time">{{ post.created_at|date:"M d, Y H:i" }}</span>
          </div>

          {% if user.is_authenticated and user != post.author %}
            <div class="follow-actions">
              {% if user in post.author.profile.followers.all %}
                <form action="{% url 'social:unfollow' post.author.username %}" method="post">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button type="submit" class="btn btn-ghost">Unfollow</button>
                </form>
              {% else %}
                <form action="{% url 'social:follow' post.author.username %}" method="post">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button type="submit" class="btn btn-ghost">Follow</button>
                </form>
              {% endif %}
            </div>
          {% endif %}
        </div>

        <div class="post-body markdown-output">
          {% if post.rendered_html %}
            {{ post.rendered_html|safe }}
          {% else %}
            <div data-post-body>{{ post.body }}</div>
          {% endif %}
        </div>

        {% if post.image %}
          <img class="post-image" src="{{ post.image.url }}" alt="post image" loading="lazy">
        {% endif %}

        <div class="actions row gap-8">
          <form action="{% url 'social:post-react' post.id 'like' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn-ghost">üëç {{ post.likes_count }}</button>
          </form>

          <form action="{% url 'social:post-react' post.id 'dislike' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn-ghost">üëé {{ post.dislikes_count }}</button>
          </form>

          <form action="{% url 'social:post-share' post.id %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn-ghost">üîÅ {{ post.shares_count }}</button>
          </form>

          {% if user.is_authenticated and user == post.author %}
            <a class="btn btn-ghost" href="{% url 'social:post-edit' post.id %}">Edit</a>
            <form action="{% url 'social:post-delete' post.id %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-ghost"
                      onclick="return confirm('Delete this post?');">Delete</button>
            </form>
          {% endif %}
        </div>

        <details class="replies">
          <summary>
            Replies ({{ post.reply_count|default:post.replies.count }})
          </summary>

          <ul class="reply-list">
            {% with rl=post.reply_list|default:post.replies.all %}
              {% for r in rl %}
                <li class="reply-item">
                  <strong>@{{ r.author.username }}</strong>
                  <span class="reply-time">{{ r.created_at|date:"M d H:i" }}</span>
                  <div class="reply-body">{{ r.body }}</div>
                </li>
              {% empty %}
                <li class="muted">No replies yet.</li>
              {% endfor %}
            {% endwith %}
          </ul>

          {% if user.is_authenticated %}
            <form action="{% url 'social:post-reply' post.id %}" method="post" class="stack gap-8">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}#post-{{ post.id }}">
              <textarea name="body" rows="3" placeholder="Write a reply‚Ä¶" required></textarea>
              <div class="row end">
                <button class="btn" type="submit">Reply</button>
              </div>
            </form>
          {% endif %}
        </details>
      </article>
    {% endfor %}
  {% else %}
    <p class="muted">No posts yet.</p>
  {% endif %}

  <nav class="pagination row gap-8 center">
    {% if page_obj.has_previous %}
      <a class="btn btn-ghost" href="?page={{ page_obj.previous_page_number }}">‚Üê Newer</a>
    {% endif %}
    <span class="muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a class="btn btn-ghost" href="?page={{ page_obj.next_page_number }}">Older ‚Üí</a>
    {% endif %}
  </nav>
{% endblock %}

{# ============ RIGHT RAIL (OPTIONAL SIDEBAR) ============ #}
{% block right_rail %}
  <section class="card">
    <h3>Tips</h3>
    <ul class="muted bullet-list">
      <li>Follow people from any post.</li>
      <li>Use Markdown in posts.</li>
      <li>Attach an image to stand out.</li>
    </ul>
  </section>
{% endblock %}
