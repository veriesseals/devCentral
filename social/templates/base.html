{% load static %}
{% load tz %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tru devCentral</title>

  <link rel="stylesheet" href="{% static 'css/style.css' %}" />

  <!-- Prism theme (one line only) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>

<body>
  <header class="dc-header">
    <div class="wrap">
      <div class="brand">
        <img src="{% static 'img/dev_central_logo.png' %}" class="logo" alt="DevCentral" />
        <h1>Tru devCentral</h1>
      </div>

      <nav>
        {% if user.is_authenticated %}
          <a class="nav-pill" href="{% url 'feed' %}">HOME FEED</a>
          <a class="nav-pill" href="{% url 'profile' user.username %}">@{{ user.username }}</a>

          <form action="{% url 'logout' %}" method="post" class="inline-logout">
            {% csrf_token %}
            <button type="submit" class="nav-pill btn-logout">Logout</button>
          </form>
        {% else %}
          <a class="nav-pill" href="{% url 'login' %}">Login</a>
          <a class="nav-pill" href="{% url 'signup' %}">Sign up</a>
        {% endif %}
      </nav>

    </div>
  </header>

  <main class="wrap">
    {% block content %}{% endblock %}
  </main>

  <!-- Password Visibility Toggle -->
  <script>
    function addPasswordToggles() {
      const pwInputs = document.querySelectorAll('input[type="password"]');
      pwInputs.forEach((input) => {
        if (input.closest('.pw-field')) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'pw-field';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'pw-toggle';
        btn.setAttribute('aria-pressed', 'false');
        btn.setAttribute('aria-label', 'Show password');
        btn.innerHTML = '<span class="eye">üëÅÔ∏è</span> Show';

        btn.addEventListener('click', () => {
          const showing = input.type === 'text';
          input.type = showing ? 'password' : 'text';
          btn.setAttribute('aria-pressed', String(!showing));
          btn.setAttribute('aria-label', showing ? 'Show password' : 'Hide password');
          btn.innerHTML = showing ? '<span class="eye">üëÅÔ∏è</span> Show' : 'üôà Hide';
          input.focus();
          const v = input.value; input.value = ''; input.value = v;
        });

        wrapper.appendChild(btn);
      });
    }
    document.addEventListener('DOMContentLoaded', addPasswordToggles);
  </script>

  <!-- Convert fenced ```lang blocks into <pre><code class="language-..."> for Prism -->
  <script>
    function convertFences(root) {
      const blocks = root.querySelectorAll('[data-post-body]');
      blocks.forEach(el => {
        if (el.dataset.fencesConverted === '1') return;
        const raw = el.textContent;
        const fenceRE = /```([a-zA-Z0-9+#\-_.]*)\n([\s\S]*?)```/g;
        let outHTML = '', idx = 0, m;
        const esc = s => s.replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
        while ((m = fenceRE.exec(raw)) !== null) {
          outHTML += esc(raw.slice(idx, m.index));
          const lang = (m[1] || 'plaintext').toLowerCase();
          outHTML += `<pre><code class="language-${lang}">${esc(m[2])}</code></pre>`;
          idx = m.index + m[0].length;
        }
        outHTML += esc(raw.slice(idx)).replace(/\n/g,'<br>');
        el.innerHTML = outHTML;
        el.dataset.fencesConverted = '1';
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      convertFences(document);
      if (window.Prism) Prism.highlightAll();
    });
  </script>

  <!-- Prism core + autoloader (loads languages on demand) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script>
    Prism.plugins.autoloader.languages_path =
      'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';
    Prism.plugins.autoloader.use_minified = true;
  </script>

  {% if messages %}
    <div class="flash">
      {% for m in messages %}<div class="flash-item">{{ m }}</div>{% endfor %}
    </div>
  {% endif %}

  <footer class="dc-footer">
    <div class="wrap">
      <span>Tru devCentral &copy; ‚Ä¢ Copyright 2025</span>
      <span>‚Ä¢ Developed by: Veries Seals III ‚Ä¢ Updated: {{ current_time|date:"M d, Y H:i:s" }}</span>
    </div>
  </footer>
</body>
</html>
