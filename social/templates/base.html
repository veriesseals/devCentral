{% load static %}
{% load tz %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tru devCentral</title>

  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <!-- Prism (theme only; core loaded at bottom) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
  <!-- Header -->
  <header class="dc-header">
    <div class="wrap head-wrap">
      <div class="brand">
        <img src="{% static 'img/dev_central_logo.png' %}" class="logo" alt="DevCentral" />
        <h1>Tru devCentral</h1>
      </div>

      <nav class="main-nav">
        {% if user.is_authenticated %}
          <a class="nav-pill" href="{% url 'social:feed' %}">Home</a>
          <a class="nav-pill" href="{% url 'social:explore' %}">Explore</a>
          <a class="nav-pill" href="{% url 'social:users' %}">Users</a>
          <a class="nav-pill" href="{% url 'social:profile' user.username %}">@{{ user.username }}</a>
          <form action="{% url 'logout' %}" method="post" class="inline-logout">
            {% csrf_token %}
            <button type="submit" class="nav-pill btn-logout">Logout</button>
          </form>
        {% else %}
          <a class="nav-pill" href="{% url 'login' %}">Login</a>
          <a class="nav-pill" href="{% url 'social:signup' %}">Sign up</a>
        {% endif %}
      </nav>
    </div>
  </header>

  {# ========= Main: app shell for signed-in users; auth shell for login/signup ========= #}
  {% if user.is_authenticated %}
    <main class="app">
      <!-- Left rail (kept empty; CSS collapses on tablet/mobile) -->
      <aside class="rail rail-left">
        {% block left_rail %}{% endblock %}
      </aside>

      <!-- Center column -->
      <section class="center">
        {% block content %}{% endblock %}
      </section>

      <!-- Right rail: vertical menu box -->
      <aside class="rail rail-right">
        {% block right_rail %}
          {# Robust ‚Äúactive‚Äù state: try url_name, fall back to path prefix checks #}
          {% with nm=request.resolver_match.url_name|default_if_none:'' p=request.path %}
          <nav class="card menu">
            <a class="menu-link{% if nm == 'feed' or p == '/' %} active{% endif %}"
               href="{% url 'social:feed' %}">Feed</a>

            <a class="menu-link{% if nm == 'posts_explore' or p|slice:':9' == '/explore/' or p == '/explore/' %} active{% endif %}"
               href="{% url 'social:explore' %}">Explore</a>

            <a class="menu-link{% if nm == 'users_list' or p|slice:':7' == '/users/' or p == '/users/' %} active{% endif %}"
               href="{% url 'social:users' %}">Users</a>

            <a class="menu-link{% if nm == 'profile' or p|slice:':3' == '/u/' %} active{% endif %}"
               href="{% url 'social:profile' user.username %}">My Profile</a>
          </nav>
          {% endwith %}
        {% endblock %}
      </aside>
    </main>
  {% else %}
    <main class="wrap auth-shell">
      {# Use this block on login/signup pages #}
      {% block auth_content %}{% endblock %}
    </main>
  {% endif %}

  <!-- Password visibility toggle -->
  <script>
    function addPasswordToggles() {
      const pwInputs = document.querySelectorAll('input[type="password"]');
      pwInputs.forEach((input) => {
        if (input.closest('.pw-field')) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'pw-field';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'pw-toggle';
        btn.setAttribute('aria-pressed', 'false');
        btn.setAttribute('aria-label', 'Show password');
        btn.innerHTML = '<span class="eye">üëÅÔ∏è</span> Show';

        btn.addEventListener('click', () => {
          const showing = input.type === 'text';
          input.type = showing ? 'password' : 'text';
          btn.setAttribute('aria-pressed', String(!showing));
          btn.setAttribute('aria-label', showing ? 'Show password' : 'Hide password');
          btn.innerHTML = showing ? '<span class="eye">üëÅÔ∏è</span> Show' : 'üôà Hide';
          input.focus();
          const v = input.value; input.value = ''; input.value = v;
        });

        wrapper.appendChild(btn);
      });
    }
    document.addEventListener('DOMContentLoaded', addPasswordToggles);
  </script>

  <!-- Convert fenced code blocks for Prism -->
  <script>
    function convertFences(root) {
      const blocks = root.querySelectorAll('[data-post-body]');
      blocks.forEach(el => {
        if (el.dataset.fencesConverted === '1') return;
        const raw = el.textContent;
        const fenceRE = /```([a-zA-Z0-9+#\-_.]*)\n([\s\S]*?)```/g;
        let outHTML = '', idx = 0, m;
        const esc = s => s.replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
        while ((m = fenceRE.exec(raw)) !== null) {
          outHTML += esc(raw.slice(idx, m.index));
          const lang = (m[1] || 'plaintext').toLowerCase();
          outHTML += `<pre><code class="language-${lang}">${esc(m[2])}</code></pre>`;
          idx = m.index + m[0].length;
        }
        outHTML += esc(raw.slice(idx)).replace(/\n/g,'<br>');
        el.innerHTML = outHTML;
        el.dataset.fencesConverted = '1';
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      convertFences(document);
      if (window.Prism) Prism.highlightAll();
    });
  </script>

  <!-- Prism core + autoloader -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <script>
    Prism.plugins.autoloader.languages_path =
      'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';
    Prism.plugins.autoloader.use_minified = true;
  </script>

  {% if messages %}
    <div class="flash">
      {% for m in messages %}<div class="flash-item">{{ m }}</div>{% endfor %}
    </div>
  {% endif %}

  <footer class="dc-footer">
    <div class="wrap">
      <span>Tru devCentral &copy; ‚Ä¢ Copyright 2025</span>
      <span>‚Ä¢ Developed by: Veries Seals III ‚Ä¢ Updated: {{ current_time|date:"M d, Y H:i:s" }}</span>
    </div>
  </footer>
</body>
</html>
